<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Inventur-Check â€“ Admin</title>
<meta name="color-scheme" content="light dark" />
<style>
  :root{
    --bg:#0b1020; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --ring:#374151;
    --brand:#00aeef; --brand-ink:#fff; --ok:#16a34a; --err:#dc2626;
  }
  @media (prefers-color-scheme: light){
    :root{--bg:#f8fafc;--card:#ffffff;--ink:#111827;--muted:#6b7280;--ring:#e5e7eb;}
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif;background:var(--bg);color:var(--ink)}
  .wrap{max-width:1000px;margin:auto;padding:24px}
  h1{margin:0 0 12px}
  .card{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.08);margin-bottom:16px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:720px){.row{grid-template-columns:1fr}}
  label{display:flex;flex-direction:column;gap:6px}
  input,textarea{background:transparent;color:var(--ink);border:1px solid var(--ring);border-radius:10px;padding:12px;min-height:44px}
  textarea{min-height:80px}
  .btn{cursor:pointer;border:1px solid var(--ring);background:transparent;color:var(--ink);border-radius:10px;padding:12px 14px;min-height:44px}
  .btn.primary{background:var(--brand);color:var(--brand-ink);border-color:transparent}
  .btn.ghost{background:transparent;border-color:var(--ring)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .status-box{position:sticky;top:8px;z-index:10;background:var(--brand);color:var(--brand-ink);border-radius:12px;padding:12px 16px;box-shadow:0 2px 6px rgba(0,0,0,.15);margin-bottom:16px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .note{color:var(--muted);font-size:.95rem}
  .msg{margin-top:10px;padding:10px 12px;border-radius:10px;font-size:.95rem}
  .msg.ok{background:rgba(22,163,74,.15);border:1px solid rgba(22,163,74,.4)}
  .msg.err{background:rgba(220,38,38,.15);border:1px solid rgba(220,38,38,.4)}
  .table{width:100%;border-collapse:separate;border-spacing:0 8px}
  .table th,.table td{padding:10px;border-top:1px solid var(--ring);border-bottom:1px solid var(--ring)}
  .table thead th{color:var(--muted);text-align:left}
  .table tr td:first-child,.table tr th:first-child{border-left:1px solid var(--ring);border-top-left-radius:10px;border-bottom-left-radius:10px}
  .table tr td:last-child,.table tr th:last-child{border-right:1px solid var(--ring);border-top-right-radius:10px;border-bottom-right-radius:10px}
  .gap{display:flex;gap:10px;flex-wrap:wrap}
  .top-actions{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px}
  a.link{color:var(--brand)}
  .hidden{display:none !important}
</style>
</head>
<body>
  <div class="wrap">
    <div class="top-actions">
      <h1>âš™ï¸ Admin â€“ Inventur-Check</h1>
      <a class="link" href="./">â† Zur Hauptseite</a>
    </div>

    <!-- GitHub Status-Leiste -->
    <section id="ghStatus" class="status-box">
      <strong>ğŸ”„ Verbindung wird geprÃ¼ft â€¦</strong><br>
      <span class="mono" id="repoInfo">tstboenen/inventur-check (main/rules.json)</span><br>
      ğŸ’¾ Daten werden zentral im GitHub-Repository gespeichert, nicht lokal.
    </section>

    <!-- Token Setup (einmal pro Session) -->
    <section id="tokenBox" class="card hidden">
      <h3>GitHub-Verbindung</h3>
      <p class="note">Der Admin-Zugriff braucht ein GitHub-Token mit <em>Contents: Read &amp; Write</em>. Das Token wird nur in dieser Browser-Session gehalten.</p>
      <div class="row">
        <label>GitHub Token
          <input id="ghToken" type="password" placeholder="github_pat_â€¦" autocomplete="off">
        </label>
      </div>
      <div class="gap" style="margin-top:12px">
        <button class="btn primary" id="btnSaveToken">ğŸ”— Token einrichten</button>
        <button class="btn ghost" id="btnClearToken">âŒ Token lÃ¶schen</button>
      </div>
      <div id="tokenMsg" class="msg hidden"></div>
    </section>

    <!-- Login -->
    <section class="card" id="authBox">
      <h3>Admin-Anmeldung</h3>
      <div class="row">
        <label>PIN
          <input id="pinLogin" type="password" inputmode="numeric" placeholder="z. B. 4927" autocomplete="off">
        </label>
      </div>
      <div class="gap" style="margin-top:12px">
        <button class="btn primary" id="btnLogin">ğŸ” Anmelden</button>
        <button class="btn" id="btnCreatePin">ğŸ†• PIN anlegen (falls noch keine)</button>
        <button class="btn ghost" id="btnShowToken">âš™ï¸ Token Ã¤ndern</button>
      </div>
      <div id="authMsg" class="msg hidden"></div>
      <p class="note" id="authHint" style="margin-top:10px">
        Erster Start: Wunsch-PIN angeben â†’ <strong>PIN anlegen</strong>. Danach mit der PIN anmelden.
      </p>
    </section>

    <!-- Admin Core -->
    <section class="card" id="adminCore" style="display:none">
      <div class="top-actions">
        <h3 style="margin:0">Regelverwaltung</h3>
        <div class="gap">
          <button class="btn" id="btnLogout">ğŸšª Abmelden</button>
          <button class="btn primary" id="btnSave">ğŸ’¾ Regeln speichern (GitHub)</button>
        </div>
      </div>

      <div class="row">
        <label>Start-Datum
          <input id="rStart" type="date">
        </label>
        <label>End-Datum (optional)
          <input id="rEnd" type="date" placeholder="leer = nur Starttag">
        </label>
      </div>
      <div class="gap" style="margin-top:10px">
        <label><input id="rFrueh" type="checkbox"> FrÃ¼hschicht muss kommen</label>
        <label><input id="rSpaet" type="checkbox"> SpÃ¤tschicht muss kommen</label>
        <label><input id="rNacht" type="checkbox"> Nachtschicht muss kommen</label>
      </div>
      <label style="margin-top:10px">Notiz (optional)
        <textarea id="rNote" rows="2" placeholder="z. B. Jahresinventur, AufrÃ¤umtageâ€¦"></textarea>
      </label>
      <div class="gap" style="margin-top:12px">
        <button class="btn" id="btnAdd">â• Regel hinzufÃ¼gen</button>
        <button class="btn" id="btnSeed">ğŸŒ± Beispielregeln</button>
        <button class="btn" id="btnClear">ğŸ—‘ï¸ Alle Regeln lÃ¶schen</button>
      </div>

      <div class="card" style="margin-top:14px">
        <h3 style="margin-top:0">Regeln</h3>
        <table class="table" id="ruleTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Start</th>
              <th>Ende</th>
              <th>FrÃ¼h</th>
              <th>SpÃ¤t</th>
              <th>Nacht</th>
              <th>Notiz</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="coreMsg" class="msg hidden"></div>
    </section>
  </div>

<script>
/* ======= Fest verdrahtetes Ziel ======= */
const TARGET = {
  owner:'tstboenen',
  repo:'inventur-check',
  branch:'main',
  path:'rules.json'
};
const API_URL = `https://api.github.com/repos/${TARGET.owner}/${TARGET.repo}/contents/${TARGET.path}?ref=${TARGET.branch}`;
const RAW_URL = `https://raw.githubusercontent.com/${TARGET.owner}/${TARGET.repo}/${TARGET.branch}/${TARGET.path}`;

const $ = (s,root=document)=>root.querySelector(s);
const ghStatus = $('#ghStatus'), repoInfo = $('#repoInfo');
repoInfo.textContent = `${TARGET.owner}/${TARGET.repo} (${TARGET.branch}/${TARGET.path})`;

function setMsg(el, type, text){
  el.classList.remove('hidden','ok','err');
  el.classList.add(type==='ok'?'ok':'err','msg');
  el.textContent = text;
}
function hide(el){ el.classList.add('hidden'); }
function show(el){ el.classList.remove('hidden'); }

/* ======= Token-Handling (Session) ======= */
function getToken(){ return sessionStorage.getItem('INV_TOKEN') || ''; }
function setToken(t){ sessionStorage.setItem('INV_TOKEN', t); }
function clearToken(){ sessionStorage.removeItem('INV_TOKEN'); }

/* ======= GitHub Status ======= */
async function checkGitHub(){
  ghStatus.innerHTML = `<strong>ğŸ”„ Verbindung wird geprÃ¼ft â€¦</strong><br><span class="mono">${TARGET.owner}/${TARGET.repo} (${TARGET.branch}/${TARGET.path})</span><br>ğŸ’¾ Daten werden zentral im GitHub-Repository gespeichert, nicht lokal.`;
  try{
    const r=await fetch(API_URL,{cache:'no-store'});
    if(r.ok){
      ghStatus.innerHTML = `<strong>âœ… Verbunden mit GitHub</strong><br><span class="mono">${TARGET.owner}/${TARGET.repo} (${TARGET.branch}/${TARGET.path})</span><br>ğŸ’¾ Daten werden zentral im GitHub-Repository gespeichert, nicht lokal.`;
    }else{
      ghStatus.innerHTML = `<strong>âŒ Keine Verbindung (${r.status})</strong><br>PrÃ¼fe Repository oder Datei.`;
    }
  }catch(e){
    ghStatus.innerHTML = `<strong>âŒ Keine Verbindung</strong><br>PrÃ¼fe Internet/GitHub.`;
  }
}
setInterval(checkGitHub, 60000);

/* ======= Daten ======= */
const DEFAULT_DATA = {
  version:3,
  pinHash:null,
  rules:[
    { start:'2025-11-14', end:'2025-11-14', frueh:false, spaet:true,  nacht:true,  note:'Inventurbeginn: SpÃ¤t 14:15, Nacht 20:45' },
    { start:'2025-11-15', end:'2025-11-15', frueh:true,  spaet:true,  nacht:false, note:'Inventur: FrÃ¼h 05:30; SpÃ¤t garantiert' },
    { start:'2025-11-16', end:'2025-11-16', frueh:false, spaet:false, nacht:false, note:'Kein Einsatz (Sonntag)' }
  ]
};
let CURRENT = structuredClone(DEFAULT_DATA);

async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest('SHA-256', enc);
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

async function loadRemote(){
  try{
    const r = await fetch(RAW_URL,{cache:'no-store'});
    if(r.status===404){ CURRENT = structuredClone(DEFAULT_DATA); return; }
    if(!r.ok) throw new Error('HTTP '+r.status);
    CURRENT = await r.json();
  }catch(e){
    CURRENT = structuredClone(DEFAULT_DATA);
  }
}

async function fetchMeta(){
  const r = await fetch(API_URL,{cache:'no-store'});
  if(r.status===404) return null;
  if(!r.ok) throw new Error('Meta '+r.status);
  return await r.json(); // contains sha
}

async function saveRemote(obj, message='Update Inventur-Regeln'){
  const token = getToken();
  if(!token) throw new Error('Kein Token vorhanden.');
  const meta = await fetchMeta();
  const body = {
    message,
    content: btoa(unescape(encodeURIComponent(JSON.stringify(obj,null,2)))),
    branch: TARGET.branch
  };
  if(meta && meta.sha) body.sha = meta.sha;
  const r = await fetch(API_URL,{
    method:'PUT',
    headers:{'Authorization':'Bearer '+token,'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if(!r.ok){
    const t = await r.text();
    throw new Error('Speichern fehlgeschlagen: '+r.status+' '+t);
  }
  return await r.json();
}

/* ======= UI: Regeln ======= */
function renderRuleTable(){
  const tb = $('#ruleTable tbody');
  tb.innerHTML = '';
  CURRENT.rules.forEach((r,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.start}</td>
      <td>${r.end||''}</td>
      <td>${r.frueh?'âœ…':'â€”'}</td>
      <td>${r.spaet?'âœ…':'â€”'}</td>
      <td>${r.nacht?'âœ…':'â€”'}</td>
      <td>${r.note||''}</td>
      <td class="gap">
        <button class="btn" data-act="up" data-idx="${i}">â¬†ï¸</button>
        <button class="btn" data-act="down" data-idx="${i}">â¬‡ï¸</button>
        <button class="btn" data-act="del" data-idx="${i}">ğŸ—‘ï¸</button>
      </td>`;
    tb.appendChild(tr);
  });
  tb.onclick = (e)=>{
    const b = e.target.closest('button[data-act]'); if(!b) return;
    const a = b.dataset.act, idx = +b.dataset.idx;
    if(a==='del'){ CURRENT.rules.splice(idx,1); }
    if(a==='up' && idx>0){ [CURRENT.rules[idx-1],CURRENT.rules[idx]]=[CURRENT.rules[idx],CURRENT.rules[idx-1]]; }
    if(a==='down' && idx<CURRENT.rules.length-1){ [CURRENT.rules[idx+1],CURRENT.rules[idx]]=[CURRENT.rules[idx],CURRENT.rules[idx+1]]; }
    renderRuleTable();
  };
}
function addRule(){
  const start = $('#rStart').value;
  const end   = $('#rEnd').value || null;
  const frueh = $('#rFrueh').checked;
  const spaet = $('#rSpaet').checked;
  const nacht = $('#rNacht').checked;
  const note  = $('#rNote').value.trim() || null;
  if(!start) return setMsg($('#coreMsg'),'err','Bitte Start-Datum wÃ¤hlen.');
  if(!frueh && !spaet && !nacht) return setMsg($('#coreMsg'),'err','Mindestens eine Schicht auswÃ¤hlen.');
  CURRENT.rules.push({start,end,frueh,spaet,nacht,note});
  CURRENT.rules.sort((a,b)=> (a.start||'').localeCompare(b.start) || (a.end||'').localeCompare(b.end||''));
  $('#rStart').value=''; $('#rEnd').value=''; $('#rFrueh').checked=false; $('#rSpaet').checked=false; $('#rNacht').checked=false; $('#rNote').value='';
  renderRuleTable();
  setMsg($('#coreMsg'),'ok','Regel hinzugefÃ¼gt (noch nicht gespeichert).');
}
function seedRules(){ CURRENT.rules = structuredClone(DEFAULT_DATA.rules); renderRuleTable(); setMsg($('#coreMsg'),'ok','Beispielregeln geladen (noch nicht gespeichert).'); }
function clearRules(){ CURRENT.rules = []; renderRuleTable(); setMsg($('#coreMsg'),'ok','Alle Regeln entfernt (noch nicht gespeichert).'); }
async function saveRules(){
  try{
    await saveRemote({version:CURRENT.version||3,pinHash:CURRENT.pinHash||null,rules:CURRENT.rules}, 'Update Regeln');
    setMsg($('#coreMsg'),'ok','Regeln erfolgreich in GitHub gespeichert.');
    checkGitHub();
  }catch(e){
    setMsg($('#coreMsg'),'err',e.message);
  }
}

/* ======= PIN ======= */
async function createPin(){
  $('#authMsg').classList.add('hidden');
  await loadRemote();
  if(CURRENT.pinHash) return setMsg($('#authMsg'),'err','PIN existiert bereits.');
  const pin = $('#pinLogin').value.trim();
  if(!pin) return setMsg($('#authMsg'),'err','Bitte eine PIN eingeben.');
  try{
    CURRENT.pinHash = await sha256Hex(pin);
    await saveRemote(CURRENT, 'Set admin PIN');
    setMsg($('#authMsg'),'ok','PIN angelegt. Bitte jetzt anmelden.');
    checkGitHub();
  }catch(e){
    setMsg($('#authMsg'),'err',e.message);
  }
}
async function login(){
  $('#authMsg').classList.add('hidden');
  await loadRemote();
  if(!CURRENT.pinHash) return setMsg($('#authMsg'),'err','Es ist noch keine PIN gesetzt. Bitte zuerst â€PIN anlegenâ€œ.');
  const pin = $('#pinLogin').value.trim();
  if(!pin) return setMsg($('#authMsg'),'err','Bitte PIN eingeben.');
  const hash = await sha256Hex(pin);
  if(hash === CURRENT.pinHash){
    $('#authBox').style.display='none';
    $('#adminCore').style.display='block';
    renderRuleTable();
    setMsg($('#coreMsg'),'ok','Erfolgreich angemeldet.');
    checkGitHub();
  } else {
    setMsg($('#authMsg'),'err','Falsche PIN.');
  }
}
function logout(){ location.reload(); }

/* ======= Boot ======= */
document.getElementById('btnLogin').addEventListener('click', login);
document.getElementById('btnCreatePin').addEventListener('click', createPin);
document.getElementById('btnSave').addEventListener('click', saveRules);
document.getElementById('btnAdd').addEventListener('click', addRule);
document.getElementById('btnSeed').addEventListener('click', seedRules);
document.getElementById('btnClear').addEventListener('click', clearRules);
document.getElementById('btnLogout').addEventListener('click', logout);

document.getElementById('btnShowToken').addEventListener('click', ()=>{
  const box = document.getElementById('tokenBox');
  box.classList.toggle('hidden');
});
document.getElementById('btnSaveToken').addEventListener('click', ()=>{
  const t = document.getElementById('ghToken').value.trim();
  if(!t){ setMsg($('#tokenMsg'),'err','Bitte Token eintragen.'); return; }
  setToken(t);
  setMsg($('#tokenMsg'),'ok','Token gespeichert (gilt fÃ¼r diese Session).');
  setTimeout(()=>hide($('#tokenMsg')),2000);
});
document.getElementById('btnClearToken').addEventListener('click', ()=>{
  clearToken();
  setMsg($('#tokenMsg'),'ok','Token entfernt.');
  setTimeout(()=>hide($('#tokenMsg')),2000);
});

/* Auto: Token-Box ausblenden, wenn Token vorhanden */
(function init(){
  checkGitHub();
  if(getToken()){
    hide($('#tokenBox'));
  }else{
    show($('#tokenBox'));
  }
})();
</script>
</body>
</html>
